<!DOCTYPE html>
<html>
<head>
  <title>Meowlinter</title>
</head>
<body>

  <h1>Meowlinter</h1>

  <form id="meowlinterForm">
    <div>
      <input type="radio" id="filepathRadio" name="input_type" value="filepath">
      <label for="filepathRadio">Filepath:</label>
      <input type="text" id="filepath" name="filepath">
    </div>

    <div>
      <input type="radio" id="codeRadio" name="input_type" value="code">
      <label for="codeRadio">Code:</label><br>
      Filename: <input type="text" id="filename" name="filename"><br>
      <textarea id="code" name="code"></textarea>
    </div>

    <button type="button" id="scanButton">Scan</button>
    <button type="button" id="saveButton" disabled>Save Report</button>
  </form>

  <div id="output"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const filepathInput = document.getElementById('filepath');
      const codeInput = document.getElementById('code');
      const filenameInput = document.getElementById('filename');
      const scanButton = document.getElementById('scanButton');
      const saveButton = document.getElementById('saveButton');
      const outputDiv = document.getElementById('output');
      const filepathRadio = document.getElementById('filepathRadio');
      const codeRadio = document.getElementById('codeRadio');

      filepathRadio.addEventListener('change', function() {
        if (filepathRadio.checked) {
          filepathInput.disabled = false;
          filenameInput.disabled = true;
          codeInput.disabled = true;
        } 
      });

      codeRadio.addEventListener('change', function() {
        if (codeRadio.checked) {
          filepathInput.disabled = true;
          filenameInput.disabled = false;
          codeInput.disabled = false;
        }
      });

      // Initial state on page load
      filepathRadio.checked = true; 
      filenameInput.disabled = true;
      codeInput.disabled = true;

      scanButton.addEventListener('click', function() {
        let filepath = filepathInput.value.trim(); 
        let code = codeInput.value;
        let filename = filenameInput.value.trim();

        if (filepath || (code && filename)) {
          if (code && filename) {
            fetch(`/check_file?filename=${filename}`)
              .then(response => response.json())
              .then(data => {
                if (data.exists) {
                  if (confirm(`A file named "${filename}" already exists. Do you want to overwrite it?`)) {
                    runMeowlinter(filename, code); 
                  } else {
                    alert("File not overwritten. Please choose a different filename.");
                  }
                } else {
                  runMeowlinter(filename, code); 
                }
              })
              .catch(error => {
                console.error("Error checking file:", error);
                alert("An error occurred while checking the file.");
              });
          } else {
            runMeowlinter(filepath, null); 
          }
        } else {
          alert("Please enter a filepath or provide code and a filename.");
        }
      });

      saveButton.addEventListener('click', function () {
        const htmlContent = outputDiv.innerHTML;
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'meowlinter_report.html';
        a.click();

        URL.revokeObjectURL(url);
      });

      function runMeowlinter(filepath, code) {
        scanButton.disabled = true;
        saveButton.disabled = true;
        outputDiv.innerHTML = "Scanning...";

        let formData = new FormData();
        formData.append('filepath', filepath);
        if (code) {
          formData.append('code', code); 
        }

        fetch('/scan', {
          method: 'POST',
          body: formData
        })
          .then(response => response.text())
          .then(html => {
            outputDiv.innerHTML = html;
            saveButton.disabled = false;
          })
          .catch(error => {
            console.error("Error during scan:", error);
            outputDiv.innerHTML = "An error occurred during the scan.";
          })
          .finally(() => {
            scanButton.disabled = false;
          });
      }
    });
  </script>

</body>
</html>